<!doctype html5>
<html>
<head>
<meta charset="utf-8">
<title>Heap Profiling Test</title>
<style>
body {font-family:sans-serif;}
button {display:block; margin:10px; padding:10px; font-size:15px;}
</style>
</head>
<body>
<h1>Heap Profiling Test</h1>
<h2>타임라인과 DOM</h2>
<p>타임라인 패널의 Record 버튼을 클릭하고, `DOM 노드 추가` 버튼을 클릭한다.<br>
Memory 탭에서 DOM 노드의 증가 개수를 확인한다.</p>
<button onclick="addDomNode();">DOM 노드 추가</button>
<button onclick="addDetachedDomNode();">도큐먼트에 추가하지 않고 DOM 노드 추가</button>
<button onclick="addManyDomNodes();">많은 수의 DOM 노드 추가</button>
<script>

// 아래 코드에 의해 DOM 노드가 증가되는 것을 확인한다.
function addDomNode() {
    document.body.appendChild(document.createElement('div'));
}

// 엘리먼트를 생성하지만 도큐먼트에는 직접 붙이지 않는다.
// 이 엘리먼트는 도큐먼트에 추가되는 것이 아니고 unreachable 임에도 불구하고
// DOM 노드의 개수가 계속 증가한다.
// GC 수행 시점이 되기까지 메모리가 가득차지 않았기 때문이다.
function addDetachedDomNode() {
    document.createElement('div');
}

// 타임라인에서 노란색 Scripting 부분만 필터링해두고 아래 함수를 호출한다.
// 가비지 컬렉팅이 수행돼서 DOM 노드의 개수가 줄어드는 걸 확인할 수 있다.
function addManyDomNodes() {
    for (var i = 0; i < 1000000; i++) {
        document.createElement('div');
    }
}


// 이 과정은 힙 프로파일링을 통해선 확인할 수 없다.
// 힙 스냅샷을 찍기 전에 GC가 수행되기 때문이다.
// 힙 프로파일링의 타임라인(오브젝트 트래커)에서도 마찬가지이다.
// 오브젝트 트래커는 50ms 단위로 힙 스냅샷을 찍는 것이며 매 수행마다 GC가 실행되기 때문이다.
// 오브젝트 트래커에서는 각 버튼을 클릭할 때마다 새 메모리가 할당되었다가,
// 가비지 컬렉트 되어 바로 회색바로 할당되는 걸 확인할 수 있다.

</script>
</body>
</html>